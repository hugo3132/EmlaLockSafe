<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EmlaLockSafe: EmlaLockSafe</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">EmlaLockSafe
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">EmlaLockSafe </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#secChangelog">Changelog of Documentation</a></li>
<li class="level1"><a href="#secSetupSafe">Setup the Safe</a><ul><li class="level2"><a href="#subHowtoFlashTheSoftware">Howto Flash the Software</a></li>
<li class="level2"><a href="#subWiFiConfig">WiFi Configuration</a></li>
<li class="level2"><a href="#subSoftwareConfiguration">Software Configuration</a></li>
</ul>
</li>
<li class="level1"><a href="#secUsingTheSafe">Using the Safe</a><ul><li class="level2"><a href="#subSafetyAspect">Safety Aspects</a></li>
<li class="level2"><a href="#subNormalOperationMode">Normal Operation Mode</a><ul><li class="level3"><a href="#subsubLockedView">Locked View</a></li>
<li class="level3"><a href="#subsubUnlockedMainMenu">Unlocked Main Menu</a></li>
<li class="level3"><a href="#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a></li>
<li class="level3"><a href="#subsubPreferencesMenu">Preferences Menu</a></li>
<li class="level3"><a href="#subsubHardwareTestView">Hardware Test View</a></li>
<li class="level3"><a href="#subsubHygieneOpeningMenu">Hygiene Opening Menu</a></li>
</ul>
</li>
<li class="level2"><a href="#subManualMode">Manual Timer Mode</a><ul><li class="level3"><a href="#subsubSetTimerView">Set Timer View</a></li>
<li class="level3"><a href="#subsubSelectDisplayTimePassed">Select Display Time Passed</a></li>
<li class="level3"><a href="#subsubSelectDisplayTimeLeft">Select Display Time Left</a></li>
</ul>
</li>
<li class="level2"><a href="#subSafeMode">Safe Mode</a><ul><li class="level3"><a href="#subsubEmergencyEnterMenuView">Emergency Enter Menu View</a></li>
<li class="level3"><a href="#subsubEmergencyMenu">Emergency Menu</a></li>
<li class="level3"><a href="#subsubEmergencyEnterKeyView">Emergency Enter Key View</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#secHardwareDescription">Hardware Description</a><ul><li class="level2"><a href="#subUnderstandingTheLockingMechanism">Understanding the locking mechanism</a></li>
<li class="level2"><a href="#subNewElectronics">New electronics</a><ul><li class="level3"><a href="#subsubControllerBoard">Controller board</a></li>
<li class="level3"><a href="#subsubIOModule">I/O module</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#secOverviewAboutSoftware">Overview about Software</a><ul><li class="level2"><a href="#subConfiguration">Configuration</a><ul><li class="level3"><a href="#subsubWifiConfigurationServer">WiFi Configuration Server</a></li>
<li class="level3"><a href="#subsubMainConfigurationServer">Main Configuration Server</a><ul><li class="level4"><a href="#parEmlaLockSettings">Emlalock Settings</a></li>
<li class="level4"><a href="#parMiscellaneousSettings">Miscellaneous Settings</a></li>
<li class="level4"><a href="#parHygieneOpeningSettings">Hygiene Opening Settings</a></li>
<li class="level4"><a href="#parTimeRestrictionsSettings">Time Restrictions Settings</a></li>
</ul>
</li>
</ul>
</li>
<li class="level2"><a href="#subLockstate">Lockstate</a></li>
<li class="level2"><a href="#subEmlaLockApi">EmlaLock API</a></li>
<li class="level2"><a href="#subViews">Views</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p > 
<script type="text/javascript" src="index.js"></script>
<script type="text/javascript" src="MenuView.js"></script>
</p>
<p >This is the documentation for the EmlaLockSafe. The sources can be found under <a href="https://github.com/hugo3132/EmlaLockSafe">https://github.com/hugo3132/EmlaLockSafe</a>.</p>
<p ><a href="https://github.com/hugo3132/EmlaLockSafe/blob/master/hardware/pictures/safe.jpg"><div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/safe.jpg" alt="" height="300px"/>
</div>
 </a></p>
<h1><a class="anchor" id="secChangelog"></a>
Changelog of Documentation</h1>
<ul>
<li>2022-01-03: Added a note to <a class="el" href="index.html#secUsingTheSafe">Using the Safe</a> which describes that the safe can be remote controlled.</li>
</ul>
<h1><a class="anchor" id="secSetupSafe"></a>
Setup the Safe</h1>
<h2><a class="anchor" id="subHowtoFlashTheSoftware"></a>
Howto Flash the Software</h2>
<p >For the development on arduino the free <a href="https://code.visualstudio.com/">Visual Studio Code</a> together with the extension <a href="https://marketplace.visualstudio.com/items?itemName=platformio.platformio-ide">PlatformIO</a> was used. After both are installed and the controller board is connected to the computer, the folder <a href="https://github.com/hugo3132/EmlaLockSafe/tree/master/software">software</a> must be opened in Visual Studio Code. selected to create an image containg everything from the <a href="https://github.com/hugo3132/EmlaLockSafe/tree/master/software/data">data</a> folder. Next, Upload Filesystem Image must be selected to flash the data folder to the controller board. Finally, Upload should be selected to compile and upload the firmware:</p>
<div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/FlashControllerBoard.png" alt="" height="400px"/>
</div>
<h2><a class="anchor" id="subWiFiConfig"></a>
WiFi Configuration</h2>
<p >After the firmware is flashed and the filesystem is uploaded the controller should automatically reboot and show the following on the display:</p>
<div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/WifiSetup.jpg" alt=""/>
</div>
<p >Since your WiFi credentials are not known yet, the controller creates a new WiFi called "SafeSetup". After connecting to the "SafeSetup" WiFi the WiFi configuration website should open automatically. If not, try to manually navigate to the website <a href="http://10.0.0.1">http://10.0.0.1</a>. On the website you should select your WiFi and enter the password which is required to connect to the network. After selecting Save Data the controller will reboot and connect to your WiFi. If anything goes wrong, you can always reset everything by flashing the filesystem image (see <a class="el" href="index.html#subHowtoFlashTheSoftware">Howto Flash the Software</a>).</p>
<p >For the detailed description of the software behind this chapter please refer to <a class="el" href="index.html#subsubWifiConfigurationServer">WiFi Configuration Server</a>.</p>
<h2><a class="anchor" id="subSoftwareConfiguration"></a>
Software Configuration</h2>
<p >After the controller rebooted and has connected to the WiFi a webserver is started. The address of the webserver is shown in the display:</p>
<p > 
<div id="_subSoftwareConfigurationView"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subSoftwareConfigurationView", "Open in Browser:", ["http://192.168.1.1", "Change WiFi Settings", "Back"]));
});</script>
</p>
<p >Since the controller is now part of your normal network it can be reached by any computer, phone, ... connected to your network.</p>
<p >For the detailed description of the software behind this chapter please refer to <a class="el" href="index.html#subsubMainConfigurationServer">Main Configuration Server</a>.</p>
<h1><a class="anchor" id="secUsingTheSafe"></a>
Using the Safe</h1>
<p >The main interaction with the safe is done using the display and the encoder knob. It is alsso possible to remote control the inferface over the same webpage as used in <a class="el" href="index.html#subSoftwareConfiguration">Software Configuration</a> (e.g. <a href="http://emlalocksafe">http://emlalocksafe</a>). Everything which is displayed on the LCD is handled by so called views. One variant of such views are menus:  
<div id="_secUsingTheSafeExampleMenu"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_secUsingTheSafeExampleMenu", "Menu Title", ["Menu Item 1", "Menu Item 2"]));
});</script>
 A menu always consists of a menu title and several menu items. A menu item can be selected by rotating the encoder. To execute the action associated with the selected item the encoder must be pushed. In case not all menu items fit onto the display, a scrollbar is displayed and the menu items are distributed to different pages.</p>
<p >When the software of the safe is booted it enters the <a class="el" href="index.html#subNormalOperationMode">Normal Operation Mode</a>. In case there are problems with the software, the safe can be started into <a class="el" href="index.html#subSafeMode">Safe Mode</a>.</p>
<dl class="section note"><dt>Note</dt><dd>To be able to use the <a class="el" href="index.html#subSafeMode">Safe Mode</a>, it is recommended to use a photo of the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a> as combination picture when setting up a new emlalock session!</dd></dl>
<h2><a class="anchor" id="subSafetyAspect"></a>
Safety Aspects</h2>
<p >The safe depends on an external 5V power supply. Therefore, it is recommended to have an charged powerbank to be able to use the safe even if there is an power outage.</p>
<p >The software is designed to make use of emlalock but not fully rely on its availability. The locking itself is not driven by the emlalock site. There is the field <a class="el" href="class_lock_state.html#aabef97159c4bd986250293b184dc8f52">LockState::endDate</a>. If it is after the current timestamp the safe will open. All values of the class <a class="el" href="class_lock_state.html">LockState</a> are stored in the internal flash memory. Therefore, it won't be lost in case of power failures.</p>
<p >As long as there is an internet connection and the emlalock site is available, the <a class="el" href="class_lock_state.html#aabef97159c4bd986250293b184dc8f52">LockState::endDate</a> is updated with the values of your current session. If there are connection problems the <a class="el" href="class_lock_state.html#aabef97159c4bd986250293b184dc8f52">LockState::endDate</a> is just no longer updated.</p>
<p >In all cases a correct system time is required to evaluate the <a class="el" href="class_lock_state.html#aabef97159c4bd986250293b184dc8f52">LockState::endDate</a>. To be independent of an working internet connection, a real-time clock module (RTC) is used. The RTC has its own battery which will keep the clock running if no external power source is connected. When the software is booting it first sets the internal system to the time provided by the RTC. As soon as a internet connection is available, the system time is synchronized with the internet using the network time protocol (NTP). The more accurate internet time is than used to update the RTC module. Therefore, the system time can be always assumed to be correct.</p>
<p >In addition, a <a class="el" href="index.html#subSafeMode">Safe Mode</a> is implemented which allows to open safe with a code.</p>
<dl class="section warning"><dt>Warning</dt><dd>In case the end date is not visible in your sesssion, it cannot be read over the API as well. Therefore, the safe can only be open if the connection to the emlalock site works. Alternatively, the <a class="el" href="index.html#subSafeMode">Safe Mode</a> must be used.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>At least in my case the mechanical keyhole is coverd by the housing of the display. Therefore, I can store the mechanical key next to the safe and just smash the display housing with an hammer in case of an emergency.</dd></dl>
<h2><a class="anchor" id="subNormalOperationMode"></a>
Normal Operation Mode</h2>
<p >Assume the safe is already properly configured as described in the previous chapter. After a reboot the software will activate the <a class="el" href="index.html#subsubLockedView">Locked View</a> in case you are in a session or if a <a class="el" href="index.html#subManualMode">manual timer</a> was set. As soon as the <a class="el" href="index.html#subEmlaLockApi">EmlaLock API</a> detects that a session was created, the safe will enter the <a class="el" href="index.html#subsubLockedView">Locked View</a> as well. In case a hygiene opening is started on the emlalock site, the <a class="el" href="index.html#subsubHygieneOpeningMenu">Hygiene Opening Menu</a> will be activated.</p>
<p >In case no session is active, the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a> will be displayed.</p>
<h3><a class="anchor" id="subsubLockedView"></a>
Locked View</h3>
<p >This view is always displayed if the safe is locked by an active session. Dependent on the configuration of the emlalock session or the <a class="el" href="index.html#subManualMode">manual timer</a>, the displayed content differs. The first line always shows the message that the safe is locked as well as the current system time.</p>
<p >The first example shows the passed time, and time which is left as well as the end date. The second example shows the content of the display in case only the temperature should be shown as indication of the time left.</p>
<p > 
<div align="center">
<div id="_subsubLockedView1" class="lcd-container" style="background-color:#33F;"></div>
<div id="_subsubLockedView2" class="lcd-container" style="background-color:#33F;"></div>
</div>
<script>
  function subsubLockedViewAnimation(lcd1, lcd2, i) {
    var minutes = Math.floor(i/60)%60;

    lcd1.writeString({string: zeroPad(59-minutes, 2), offset: 55});
    lcd1.writeString({string: zeroPad(59-i%60, 2), offset: 58});

    i++;
    if(i == 3600)
      i = 1;
    var minutes = Math.floor(i/60)%60;

    lcd1.writeString({string: zeroPad(minutes, 2), offset: 16});

    lcd1.writeString({string: zeroPad(minutes, 2), offset: 35});
    lcd1.writeString({string: zeroPad(i%60, 2), offset: 38});
    lcd2.writeString({string: zeroPad(minutes, 2), offset: 35});
    lcd2.writeString({string: zeroPad(i%60, 2), offset: 38});


    setTimeout(subsubLockedViewAnimation.bind(null, lcd1, lcd2, i), 1000);
  }

  document.addEventListener('DOMContentLoaded', function(){
    lcd1 = new LCD({elem: document.getElementById("_subsubLockedView1"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd1.writeString({string: "Safe Locked  12:45", offset: 0});
    lcd1.writeString({string: "Passed: 000:00:00:30", offset: 20});
    lcd1.writeString({string: "Left:   006:23:59:30", offset: 40});
    lcd1.writeString({string: " 12.09.2020 12:43:46", offset: 60});
    lcd2 = new LCD({elem: document.getElementById("_subsubLockedView2"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd2.writeString({string: "Safe Locked  12:45", offset: 0});
    lcd2.writeString({string: "Passed: 000:00:00:30", offset: 20});
    lcd2.writeString({string: "Left: verycold", offset: 40});

    setTimeout(subsubLockedViewAnimation.bind(null, lcd1, lcd2, 1351), 1000);
  });
</script>
</p>
<h3><a class="anchor" id="subsubUnlockedMainMenu"></a>
Unlocked Main Menu</h3>
<p >In case the safe should not be locked this is the main menu.</p>
<p > 
<div id="_subsubEmptyMenu"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubEmptyMenu", "Unlocked Main Menu", 
             ["Open Safe", "Set Custom Timer", "Emlalock Unlock Key", "Preferences", "Hardware Test View", "Reboot"]));
});</script>
</p>
<p >From the main menu the following can be done:</p><ul>
<li><b>Open safe:</b> After selecting this option, the software will trigger a refresh of the emlalock safe. In case there is still no session active, the coil will be pulled an the safe can be opened. In case a session was created in the meantime, the safe will enter the <a class="el" href="index.html#subsubLockedView">Locked View</a>.</li>
<li><b>Set Custom Timer:</b> With this option the <a class="el" href="index.html#subManualMode">Manual Timer Mode</a> can be configured.</li>
<li><b>Emlalock Unlock Key:</b> This option will activate the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a>. In the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a> the emergency unlock key is displayed and can be changed (see also <a class="el" href="index.html#subSafeMode">Safe Mode</a>).</li>
<li><b>Preferences:</b> Opens the <a class="el" href="index.html#subsubPreferencesMenu">Preferences Menu</a>.</li>
<li><b>Hardware Test View:</b> Starts the <a class="el" href="index.html#subsubHardwareTestView">Hardware Test View</a> which allows to see the state of the RTC and test the encoder and coil. The view can only be left by disconnecting the power supply.</li>
<li><b>Reboot:</b> Reboots the controller.</li>
</ul>
<h3><a class="anchor" id="subsubEmlalockUnlockKeyMenu"></a>
Emlalock Unlock Key Menu</h3>
<p >This menu can be entered using the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a>. It shows the current emergency unlock key which can be used to unlock the safe in the ref subSafeMode. A photograph of this view should be used as combination picture for your emlalock session.</p>
<p >It is also possible to select generate a new key. The previous key will then no longer be valid.</p>
<p > 
<div id="_subsubEmlalockUnlockKeyMenu"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubEmlalockUnlockKeyMenu", "Emlalock Unlock Key", ["Current key: USPV02", "Generate new key", "Back"]));
});</script>
</p>
<h3><a class="anchor" id="subsubPreferencesMenu"></a>
Preferences Menu</h3>
<p >This menu can be entered using the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a>.</p>
<p > 
<div id="_subsubPreferencesMenu"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubPreferencesMenu", "Preferences", ["Change Wifi Settings", "Start Configuration Server", "Restore Factory Defaults", "Back"]));
});</script>
</p>
<p >The following actions can be selected:</p><ul>
<li><b>Change Wifi Settings:</b> Deletes the WiFi credentials and restarts the controller. After the reboot the controller will start the <a class="el" href="index.html#subWiFiConfig">WiFi Configuration</a> server.</li>
<li><b>Start Configuration Server:</b> Activates the <a class="el" href="index.html#subSoftwareConfiguration">Software Configuration</a> server.</li>
<li><b>Restore Factory Defaults:</b> Deletes all configuration data. After the reboot the controller will start the <a class="el" href="index.html#subWiFiConfig">WiFi Configuration</a> server.</li>
<li><b>Back:</b> Return to the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a>.</li>
</ul>
<h3><a class="anchor" id="subsubHardwareTestView"></a>
Hardware Test View</h3>
<p >This view can be used to test the hardware. As soon as it is activated, the coil is pulled and released with 0.5Hz. In addition, if the encoder nob used the action is diplayed. Finally the current time of the real-time clock (R) and local system time (S) is displayed. </p><dl class="section note"><dt>Note</dt><dd>The RTC is always set to UTC.</dd></dl>
<p> 
<div align="center">
<div id="_subsubHardwareTestView" class="lcd-container" style="background-color:#33F;"></div>
</div>
<script>
  function subsubHardwareTestViewAnimation(lcd, i) {
    switch(i%4) {
      case 0:
        s = "Clicked             ";
        break;
      case 1:
        s = "CLOCKWISE           ";
        break;
      case 2:
        s = "COUNTERCLOCKWISE    ";
        break;
      case 3:
        s = "                    ";
        break;
    }
    lcd.writeString({string: s, offset: 20});

    var minutes = Math.floor(i/60)%60;
    lcd.writeString({string: zeroPad(minutes, 2), offset: 54});
    lcd.writeString({string: zeroPad(minutes, 2), offset: 74});
    lcd.writeString({string: zeroPad(i%60, 2), offset: 57});
    lcd.writeString({string: zeroPad(i%60, 2), offset: 77});

    setTimeout(subsubHardwareTestViewAnimation.bind(null, lcd, i + 1), 1000);
  }

  document.addEventListener('DOMContentLoaded', function(){
    lcd = new LCD({elem: document.getElementById("_subsubHardwareTestView"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd.writeString({string: "Encoder Test", offset: 0});
    lcd.writeString({string: "R 23.12.21 13:00:21", offset: 40});
    lcd.writeString({string: "S 23.12.21 14:00:21", offset: 60});

    setTimeout(subsubHardwareTestViewAnimation.bind(null, lcd, 25), 1000);
  });
</script>
</p>
<h3><a class="anchor" id="subsubHygieneOpeningMenu"></a>
Hygiene Opening Menu</h3>
<p >This menu is activated in case a hygiene opening is started on the emlalock site.</p>
<p > 
<div id="_subsubHygieneOpeningMenu"></div>
<script>
  function subsubHygieneOpeningMenu(menuItem, i) {
    if(i < 0) {
      i = 3599;
    }
    
    menuItem.text = "Time Left: 00:" + zeroPad(Math.floor(i/60)%60, 2) + ":" + zeroPad(i%60, 2);
    setTimeout(subsubHygieneOpeningMenu.bind(null, menuItem, i - 1), 1000);
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    var menu = new MenuView("_subsubHygieneOpeningMenu", "Hygiene Opening", ["Open Safe", "Emlalock Unlock Key", "Time Left: 00:00:00"]);
    menus.push(menu);
    setTimeout(subsubHygieneOpeningMenu.bind(null, menu.menuItems[2], 3599), 1000);

});</script>
</p>
<p >From the menu the following can be done:</p><ul>
<li><b>Open safe:</b> After selecting this option, the software will trigger a refresh of the emlalock safe. In case the hygiene opening is still active, the coil will be pulled an the safe can be opened.</li>
<li><b>Emlalock Unlock Key:</b> This option will activate the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a>. In the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a> the emergency unlock key is displayed and can be changed (see also <a class="el" href="index.html#subSafeMode">Safe Mode</a>).</li>
</ul>
<p >In addition, the time left in the hygiene opening is displayed.</p>
<h2><a class="anchor" id="subManualMode"></a>
Manual Timer Mode</h2>
<p >The manual timer mode is an alternative to emlalock. It allows to lock the safe for a certain time. From the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a> the entry Set Custom Timer should be selected to start the <a class="el" href="index.html#subsubSetTimerView">Set Timer View</a>.</p>
<h3><a class="anchor" id="subsubSetTimerView"></a>
Set Timer View</h3>
<p >The view allows to set the a custom timer. The number marked with "&gt; &lt;" can be changed by rotating the encoder. To switch to the next number the encoder must be pressed. At the bottom, the computed end date is displayed. After the time is set and confirmed, <a class="el" href="index.html#subsubSelectDisplayTimePassed">Select Display Time Passed</a> will be displayed next.</p>
<p > 
<div align="center">
<div id="_subsubSetTimerView" class="lcd-container" style="background-color:#33F;"></div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    lcd = new LCD({elem: document.getElementById("_subsubSetTimerView"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd.writeString({string: "Set Lock Timer:", offset: 0});
    lcd.writeString({string: "0 days", offset: 20});
    lcd.writeString({string: ">1<hours 0 minutes", offset: 40});
    lcd.writeString({string: "(23.12.2021 15:32)", offset: 60});
  });
</script>
</p>
<h3><a class="anchor" id="subsubSelectDisplayTimePassed"></a>
Select Display Time Passed</h3>
<p >After the time is set, the this view allows to select if the the time passed should be displayed or not. If Yes or No is selected, the view <a class="el" href="index.html#subsubSelectDisplayTimeLeft">Select Display Time Left</a> will be activated. If Cancel is selected, the safe will return to the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a>.</p>
<p > 
<div id="_subsubSelectDisplayTimePassed"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubSelectDisplayTimePassed", "Display time passed?", ["Yes", "No", "Cancel"]));
});</script>
</p>
<h3><a class="anchor" id="subsubSelectDisplayTimeLeft"></a>
Select Display Time Left</h3>
<p >This this view allows to select if the the time left should be displayed or not. After selecting Yes, No or Temperature, the safe will be locked until the time is up. If Cancel is selected, the safe will return to the <a class="el" href="index.html#subsubUnlockedMainMenu">Unlocked Main Menu</a>.</p>
<p > 
<div id="_subsubSelectDisplayTimeLeft"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubSelectDisplayTimeLeft", "Display time left?", ["Yes", "No", "Temperature", "Cancel"]));
});</script>
</p>
<h2><a class="anchor" id="subSafeMode"></a>
Safe Mode</h2>
<p >The safe mode can be used to open the safe in case of software problems. As long as the safe is unlocked the <a class="el" href="index.html#subsubEmlalockUnlockKeyMenu">Emlalock Unlock Key Menu</a> can be opened to display or change the emergency unlock key. To enter the safe mode, the encoder nob must be pressed while connecting the power supply. If the nob is pressed during booting, the <a class="el" href="index.html#subsubEmergencyEnterMenuView">Emergency Enter Menu View</a> is displayed. After 2 seconds the safe will enter the <a class="el" href="index.html#subsubEmergencyMenu">Emergency Menu</a> without connecting to the WiFi.</p>
<h3><a class="anchor" id="subsubEmergencyEnterMenuView"></a>
Emergency Enter Menu View</h3>
<p > 
<div align="center">
<div id="_subsubEmergencyEnterMenuView" class="lcd-container" style="background-color:#33F;"></div>
</div>
<script>
  function subsubEmergencyEnterMenuViewAnimation(lcd, i) {
    s = "";
    if(i < 25) {
      for(var j = 0; j < Math.min(20, i); j++) {
        s = s + "*";
      }
    }
    else {
      s = "                    ";      
      if(i > 30) {
        i = -1;
      }
    }
    lcd.writeString({string: s, offset: 60});
    setTimeout(subsubEmergencyEnterMenuViewAnimation.bind(null, lcd, i + 1), 100);
  }

  document.addEventListener('DOMContentLoaded', function(){
    lcd = new LCD({elem: document.getElementById("_subsubEmergencyEnterMenuView"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd.writeString({string: "Keep button pressed", offset: 0});
    lcd.writeString({string: "to enter emergency", offset: 20});
    lcd.writeString({string: "menu.", offset: 40});

    setTimeout(subsubEmergencyEnterMenuViewAnimation.bind(null, lcd, 0), 100);
  });
</script>
</p>
<h3><a class="anchor" id="subsubEmergencyMenu"></a>
Emergency Menu</h3>
<p > 
<div id="_subsubEmergencyMenu"></div>
<script>document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subsubEmergencyMenu", "Emergency Menu", ["Unlock with key", "Start Wifi", "Offline Mode"]));
});</script>
</p>
<p >The emergency menu allows to select one of the following actions:</p><ul>
<li><b>Unlock with key:</b> Opens the <a class="el" href="index.html#subsubEmergencyEnterKeyView">Emergency Enter Key View</a> to open the safe with the emergency unlock key</li>
<li><b>Start Wifi:</b> Connects to the WiFi and continues booting</li>
<li><b>Offline Mode:</b> Continues booting without connecting to the WiFi</li>
</ul>
<h3><a class="anchor" id="subsubEmergencyEnterKeyView"></a>
Emergency Enter Key View</h3>
<p >In this view the emergency key can be entered to unlock the safe. The letter marked with "&gt; &lt;" can be changed by rotating the encoder nob. To switch to the next letter, the nob must be pushed.</p>
<p >After entering the last character of the key, the key is verified. If the correct key was entered, the safe unlocks.</p>
<p > 
<div align="center">
<div id="_subsubEmergencyEnterKeyView" class="lcd-container" style="background-color:#33F;"></div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    lcd = new LCD({elem: document.getElementById("_subsubEmergencyEnterKeyView"),rows: 4,columns: 20,pixelSize: 2,pixelColor: "#FFF"});
    lcd.writeString({string: "Enter emergency key:", offset: 0});
    lcd.writeString({string: "   U>S<A A A A", offset: 60});
  });
</script>
</p>
<h1><a class="anchor" id="secHardwareDescription"></a>
Hardware Description</h1>
<h2><a class="anchor" id="subUnderstandingTheLockingMechanism"></a>
Understanding the locking mechanism</h2>
<p >I've used a <a href="https://www.bauhaus.info/tresore/moebeleinsatztresor-security-box-mini/p/23519628">cheap safe from a local hardware store</a>. But any cheap safe should do the trick as long as it can be electronically unlocked and easily disassembled. Try to look for a safe which is powered by 4 batteries (4 x 1.5V). Then the chances are high that the 5V of the controller board are high enough to pull the coil. The cheaper the safe the easier it might be to drill the holes into it to mount everything. After removing the cover on the inside of the safe, the original electronics board can be removed and the mechanism looks as follows:</p>
<div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/coil.png" alt=""/>
</div>
<p >On the left side of the picture the safe is locked. The pin of the coil is pushed upwards by a spring and the mechanism is blocked. As soon as a current is applied to the coil, the pin is pulled down and the safe can be opened. The mechanism is also the reason why these safe must be mounted to something solid (e.g. a wall). Otherwise you can hit the safe from the top which pushes down the spring for a few milliseconds in which the safe can be unlocked.</p>
<h2><a class="anchor" id="subNewElectronics"></a>
New electronics</h2>
<p >The idea of this project is now to replace the original electronics with a controller which checks the EmlaLock API if it can be opened or not. To be able to connect to the internet I first started using a ESP8266. After a while I ran out of memory while parsing the JSON file delivered by the EmlaLock API. Therefore, I had to switch to the more powerful <a href="https://www.amazon.de/AZDelivery-Bluetooth-Internet-Entwicklungsboard-kompatibel/dp/B08BTYCGVV">ESP32 D1 mini module</a>. The controller module is extended by a <a href="https://www.amazon.de/AZDelivery-Real-Clock-DS3231-Parent/dp/B07ZQGBH14">real-time clock (RTC) module</a>. As long as the controller has a WiFi connection the time of the RTC module is set using the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">network time protocol</a>. In case the WiFi connection is lost the controller is able to get the time from the RTC module even after the power outage (see also <a class="el" href="index.html#subSafetyAspect">Safety Aspects</a>). This is important in case the @refg subManualMode is used.</p>
<p >The controller and RTC module are both part of the <a class="el" href="index.html#subsubControllerBoard">Controller board</a> which is mounted inside the safe. The <a class="el" href="index.html#subsubControllerBoard">Controller board</a> is extended by the <a class="el" href="index.html#subsubIOModule">I/O module</a> mounted to the outside of the safe which contains a <a href="https://www.amazon.de/AZDelivery-Bundle-2004-blau-Parent/dp/B07Z6CPTF4">HD44780 display with an IÂ²C converter</a> and a <a href="https://www.amazon.de/WayinTop-Encoder-Drehgeber-Drehwinkelgeber-Druckknopf/dp/B07T3672VK">rotary encoder</a>. Since the controller display requires 5V and the controller runs with 3.3V, a <a href="https://www.amazon.de/gp/product/B07LG6RK7L">logic level converter</a> is added between the controller board and the LCD module.</p>
<h3><a class="anchor" id="subsubControllerBoard"></a>
Controller board</h3>
<p >The controller board contains the ESP32 controller and the RTC as well as some electronics which can open the coil. The controller board is mounted inside the safe to ensure the firmware cannot be modified while the safe is locked. For the power supply of the controller a USB cable without data-pins should be used (either by disconnecting them or using a USB power cable).</p>
<p > 
<div align="center"><img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/Schematics/EmlaLockSafe_Controller_Board.svg" width="1024px"></div>
</p>
<p >A two-layer board layout can be found under <a href="https://github.com/hugo3132/EmlaLockSafe/tree/master/hardware">https://github.com/hugo3132/EmlaLockSafe/tree/master/hardware</a>. I also added the files I've used when I ordered the PCB from [<a href="https://www.jlcpcb.com/">https://www.jlcpcb.com/</a>](jlcpcb) under <a href="https://github.com/hugo3132/EmlaLockSafe/tree/master/hardware/JLCPCB%20Job">https://github.com/hugo3132/EmlaLockSafe/tree/master/hardware/JLCPCB%20Job</a>. The assembled board looks like:</p>
<div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/ControllerBoard.jpg" alt="" width="500px"/>
</div>
<h3><a class="anchor" id="subsubIOModule"></a>
I/O module</h3>
<p >The I/O module is responsible for displaying the current state and is therefore mounted to the outside of the safe. It consists of:</p><ul>
<li>HD44780 based LCD module</li>
<li>HD44780 to I2C converter</li>
<li>logic level converter</li>
<li>rotary encoder</li>
</ul>
<p > 
<div align="center"><img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/Schematics/EmlaLockSafe_IO_Module_Schematic.svg" width="1024px"></div>
</p>
<p >Everything is mounted to a 3D printed case. The STL file can be downloaded from <a href="https://github.com/hugo3132/EmlaLockSafe/raw/master/hardware/EmlaLockSafe_IO_Module_Case.7z">https://github.com/hugo3132/EmlaLockSafe/raw/master/hardware/EmlaLockSafe_IO_Module_Case.7z</a>. The case itself was created using the free version of onshape. If it should be modified you can use the following link <a href="https://cad.onshape.com/documents/5e5c868aceb5d7f8533767fd/w/02a796cf0a235e5fc50259cc/e/6ff6b7a15110ccacfdb04374">https://cad.onshape.com/documents/5e5c868aceb5d7f8533767fd/w/02a796cf0a235e5fc50259cc/e/6ff6b7a15110ccacfdb04374</a> and modify it to your own needs.</p>
<p > 
<div align="center">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/DisplayModule_Back.jpg" height="300">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/DisplayModule_Front.jpg" height="300">
</div>
</p>
<p >For the I/O module no PCB is required. Everything is directly soldered to each other or connected with some cables.</p>
<h1><a class="anchor" id="secOverviewAboutSoftware"></a>
Overview about Software</h1>
<p >The EmlaLockSafe uses an ESP32 processor board to open the attached safe dependent on your session on <a href="https://www.emlalock.com">emlalock.com</a>. The software running on the EPS32 is speparated into different parts which are described in the following sections.</p>
<p >The <a class="el" href="index.html#subConfiguration">first section</a> covers how the webservers are used to configure the software. The section <a class="el" href="index.html#subLockstate">Lockstate</a> shows how the software handles if it should open or not and what is shown on the display. The section <a class="el" href="index.html#subEmlaLockApi">EmlaLock API</a> shows how the software interacts with the API of <a href="https://www.emlalock.com">emlalock.com</a>.</p>
<p >Except of the <a class="el" href="index.html#subsubWifiConfigurationServer">WiFi Configuration Server</a>, everything what is displayed on the LCD is using <a class="el" href="index.html#subViews">Views</a>. A view can be what's currently displayed, a dialog or an menu. For the navigation within the views, the encoder nob can be used.</p>
<dl class="section warning"><dt>Warning</dt><dd>If the filesystem in the flash memory (SPIFFS) is accessed the interrupts must be temorarily deactivated. The class <a class="el" href="class_used_interrupts.html">UsedInterrupts</a> provides an <a class="el" href="class_used_interrupts.html#aad496f7de1b405ad5e8e1996283e87c1">attach</a> and <a class="el" href="class_used_interrupts.html#af79f25961986a8f91fa207b8381682f9">detach</a> function to temporarily deactivated the interrupts. An other option is to use the function <a class="el" href="class_used_interrupts.html#a7783d371f93af2c1c7d70c4183304047">executeWithoutInterrupts</a> which accepts a lamda expression which is executed while the interrupts are detached.</dd></dl>
<h2><a class="anchor" id="subConfiguration"></a>
Configuration</h2>
<p >The configuration is stored in the fields of the <a class="el" href="classconfiguration_1_1_configuration.html">configuration::Configuration</a> class. It automatically loads and saves all parameters to the file /configuration.txt. The filesystem is located in an SPIFFS in the ESP32's flash memory. To change the configuration two webservers are used. The first sever (see <a class="el" href="index.html#subsubWifiConfigurationServer">WiFi Configuration Server</a>) is always started automatically when the WiFi credentials are not complete. The second server (see <a class="el" href="index.html#subsubMainConfigurationServer">Main Configuration Server</a>) is automatically started if the EmlaLock API is not configured. Both servers can also be started using the <a class="el" href="index.html#subsubPreferencesMenu">Preferences Menu</a>. The webservers are derived <a class="el" href="classconfiguration_1_1_configuration_server_base.html">configuration::ConfigurationServerBase</a>. The base class provides the function <a class="el" href="classconfiguration_1_1_configuration_server_base.html#a27025824b06f68019d9202f1adf2e4e3">addSpiffsFileToServer()</a> which makes a file in the SPIFFS available on the webserver. In addition, jquery and the main CSS file is added.</p>
<h3><a class="anchor" id="subsubWifiConfigurationServer"></a>
WiFi Configuration Server</h3>
<p >The server is started as soon as the WiFi SSID or password is empty in the <a class="el" href="classconfiguration_1_1_configuration.html">configuration::Configuration</a> class. Since the WiFi credentials are not known, the ESP32 acts as access point with the SSID SafeSetup (see <a class="el" href="classconfiguration_1_1_wifi_configuration_server.html#a615859554e70e2b06a1611ecb28585fa">createAp()</a>). Additionally, a DNS server is started which resolves any request to the IP address of the ESP32. This is necessary to implemented a captive portal which automatically forwards any client which connects to the WiFi to the configuration website. If the captive portal does not work, the necessary steps are also displayed on the LCD:</p>
<p ><a href="https://github.com/hugo3132/EmlaLockSafe/blob/master/hardware/pictures/WifiSetup.jpg"><div class="image">
<img src="https://raw.githubusercontent.com/hugo3132/EmlaLockSafe/master/hardware/pictures/WifiSetup.jpg" alt="" height="300px"/>
</div>
 </a></p>
<p >The webserver mainly provides the <a href="https://github.com/hugo3132/EmlaLockSafe/blob/master/software/data/indexWifi.html">indexWifi.html</a> (see <a class="el" href="classconfiguration_1_1_wifi_configuration_server.html#ac46fe0f0dfa7a242b6799ae3422db5cd">configureWebserver()</a>). It also provides a generated text-file with all visible WiFi networks. The list is automatically updated in the <a class="el" href="classconfiguration_1_1_wifi_configuration_server.html#abcce3bc2776758a2a5e57660f9b1f0b0">loop()</a> function.</p>
<h3><a class="anchor" id="subsubMainConfigurationServer"></a>
Main Configuration Server</h3>
<p >The main configuration server is a webserver to configure everything except of the WiFi settings. The main website provided by the server is the file [indexConfig.html](<a href="https://github.com/hugo3132/EmlaLockSafe/blob/master/software/data/indexConfig.html">https://github.com/hugo3132/EmlaLockSafe/blob/master/software/data/indexConfig.html</a>") (preview without backend
 &lt;a href="indexConfig.html" target="_blank"&gt;indexConfig.html&lt;/a&gt;). The webserver is automatically 
started and stopped by the @ref views::ConfigurationServerView. As mentioned before, the @ref views::ConfigurationServerView "view" and therefore also the 
webserver is activated automatically after a reboot if the EmlaLock API is not configured. When the @ref views::ConfigurationServerView is active, it 
provides a menu entry to reset the WiFi settings and reboot. After the reboot, the @ref subsubWifiConfigurationServer will be automatically started. This
might become necessary if the software is not able to connect to your WiFi. In addition, the @ref subsubWifiConfigurationServer shows the IP which can 
be used to access the configuration site.

@htmlonly 
&lt;div id="_subMainConfigurationServerView"&gt;&lt;/div&gt;
&lt;script&gt;document.addEventListener('DOMContentLoaded', function() {
menus.push(new MenuView("_subMainConfigurationServerView", "Open in Browser:", ["<a href="http://192.168.1.1">http://192.168.1.1</a>", "Change WiFi Settings", "Back"]));
});&lt;/script&gt;
@endhtmlonly

Currently the following values can be set:

@paragraph parEmlaLockSettings Emlalock Settings
- User ID
- API Key
- The Emergency Key
- The behavior in case a session is ended as failed session

@paragraph parMiscellaneousSettings Miscellaneous Settings
- Timezone
- Backlight Timeout

@paragraph parHygieneOpeningSettings Hygiene Opening Settings
- AutoLock after time is over

@paragraph parTimeRestrictionsSettings Time Restrictions Settings
It is possible to limit the time when the safe can be opened. The specified time span can be applied one or several of the following aspects:
- the normal unlock function
- the configuration server
- unlock during hygiene openings
- unlock using the emergency key


@subsection subLockstate Lockstate
TBD


@subsection subEmlaLockApi EmlaLock API
TBD

@subsection subViews Views
The views itself are described in @ref secUsingTheSafe. All views are global and can be accessed over the 
&lt;a href="<a href="https://github.com/hugo3132/EmlaLockSafe/blob/master/software/src/views/ViewStore.h">https://github.com/hugo3132/EmlaLockSafe/blob/master/software/src/views/ViewStore.h</a>" &gt;ViewStore.</p>
<p >TBD </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Mar 18 2022 15:16:24 for EmlaLockSafe by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3 </li>
  </ul>
</div>
</body>
</html>
